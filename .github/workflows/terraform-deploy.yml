# =============================================================================
# REUSABLE TERRAFORM DEPLOY WORKFLOW
# =============================================================================
# This is a centralized, reusable workflow for Terraform deployments.
# Handles: Plan â†’ Approval â†’ Apply
#
# Usage in consuming repository:
#   jobs:
#     deploy:
#       uses: your-org/platform-workflows/.github/workflows/terraform-deploy.yml@v1
#       with:
#         working_directory: "environments/dev"
#         environment: "dev"
#       secrets:
#         AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}
#
# =============================================================================

name: Terraform Deploy (Reusable)

on:
  workflow_call:
    inputs:
      # -----------------------------------------------------------------------
      # Required Inputs
      # -----------------------------------------------------------------------
      working_directory:
        description: 'Working directory for Terraform commands'
        required: true
        type: string
      environment:
        description: 'Environment name for deployment (must match GitHub environment)'
        required: true
        type: string

      # -----------------------------------------------------------------------
      # Optional Inputs
      # -----------------------------------------------------------------------
      terraform_version:
        description: 'Terraform version to use'
        required: false
        type: string
        default: '1.9.0'
      aws_region:
        description: 'AWS region for operations'
        required: false
        type: string
        default: 'us-east-1'
      plan_timeout_minutes:
        description: 'Timeout for plan job in minutes'
        required: false
        type: number
        default: 30
      apply_timeout_minutes:
        description: 'Timeout for apply job in minutes'
        required: false
        type: number
        default: 60

    secrets:
      AWS_ROLE_ARN:
        description: 'AWS IAM Role ARN for OIDC authentication'
        required: true

    outputs:
      plan_exitcode:
        description: 'Terraform plan exit code (0=no changes, 2=changes)'
        value: ${{ jobs.plan.outputs.plan_exitcode }}
      apply_result:
        description: 'Apply job result'
        value: ${{ jobs.apply.result }}

jobs:
  # ===========================================================================
  # Plan
  # ===========================================================================
  plan:
    name: ðŸ“ Plan
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    outputs:
      plan_exitcode: ${{ steps.plan.outputs.exitcode }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform_version }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: terraform-plan-${{ github.run_id }}
          aws-region: ${{ inputs.aws_region }}
          audience: sts.amazonaws.com
          output-env-credentials: true

      - name: Terraform Init
        working-directory: ${{ inputs.working_directory }}
        run: terraform init

      - name: Terraform Plan
        id: plan
        working-directory: ${{ inputs.working_directory }}
        timeout-minutes: ${{ inputs.plan_timeout_minutes }}
        run: |
          set +e
          terraform plan -detailed-exitcode -out=tfplan -input=false 2>&1 | tee plan_output.txt
          EXITCODE=$?
          set -e
          echo "exitcode=$EXITCODE" >> $GITHUB_OUTPUT
          
          # Exit code 0 = no changes, 1 = error, 2 = changes to apply
          if [ $EXITCODE -eq 1 ]; then
            echo "âŒ Terraform plan failed"
            exit 1
          fi
        env:
          AWS_DEFAULT_REGION: ${{ inputs.aws_region }}

      - name: Show Plan Summary
        if: always()
        working-directory: ${{ inputs.working_directory }}
        run: |
          echo "## ðŸ“ Terraform Plan - ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat plan_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ inputs.environment }}
          path: |
            ${{ inputs.working_directory }}/tfplan
            ${{ inputs.working_directory }}/plan_output.txt
          retention-days: 7

  # ===========================================================================
  # Manual Approval Gate
  # ===========================================================================
  approve:
    name: âœ‹ Approval Required
    runs-on: ubuntu-latest
    needs: plan
    environment:
      name: ${{ inputs.environment }}
      url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
    steps:
      - name: Approval granted
        run: |
          echo "## âœ… Deployment Approved" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Approved by | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Time | $(date -u) |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Apply
  # ===========================================================================
  apply:
    name: ðŸš€ Apply
    runs-on: ubuntu-latest
    needs: approve
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform_version }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: terraform-apply-${{ github.run_id }}
          aws-region: ${{ inputs.aws_region }}
          audience: sts.amazonaws.com
          output-env-credentials: true

      - name: Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ inputs.environment }}
          path: ${{ inputs.working_directory }}

      - name: Terraform Init
        working-directory: ${{ inputs.working_directory }}
        run: terraform init

      - name: Terraform Apply
        working-directory: ${{ inputs.working_directory }}
        timeout-minutes: ${{ inputs.apply_timeout_minutes }}
        run: |
          echo "ðŸš€ Applying Terraform plan to ${{ inputs.environment }}..."
          terraform apply -auto-approve tfplan
        env:
          AWS_DEFAULT_REGION: ${{ inputs.aws_region }}

      - name: Apply Summary
        if: always()
        run: |
          echo "## ðŸš€ Terraform Apply - ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ job.status == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Run ID | ${{ github.run_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Actor | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
